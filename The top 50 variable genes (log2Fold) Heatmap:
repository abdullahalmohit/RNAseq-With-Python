# === Import necessary libraries ===
import numpy as np
import seaborn as sns
import matplotlib.pyplot as plt
import pandas as pd

# === Load TPM expression matrix ===
# Rows = genes, Columns = samples; first column should be gene IDs
tpm_df = pd.read_excel("Your_file_path.xlsx", index_col=0)

# === Customizable Options ===
color_map = "RdBu_r"        # Diverging colormap (red = up, blue = down)
figure_width = 14           # Width of heatmap
figure_height = 10          # Height of heatmap
top_n_genes = 50            # Number of most variable genes to plot

# === Define Control Sample ===
# Assumes first column = control; replace if needed (e.g., "Control")
control_sample = tpm_df.columns[0]

# === Compute log2 Fold Change with pseudocount ===
# Formula: log2((treatment + 1) / (control + 1))
log2fc_df = np.log2((tpm_df + 1).divide(tpm_df[control_sample] + 1, axis=0))

# === Select Top Variable Genes ===
top_genes = log2fc_df.var(axis=1).sort_values(ascending=False).head(top_n_genes).index
heatmap_data = log2fc_df.loc[top_genes]

# === Plot Heatmap ===
plt.figure(figsize=(figure_width, figure_height))
sns.heatmap(
    heatmap_data,
    cmap=color_map,
    center=0,                      # 0 = no change
    xticklabels=True,
    yticklabels=True,
    cbar_kws={'label': 'log₂ Fold Change'}
)

# Add title
plt.title(f"Heatmap of Top {top_n_genes} Variable Genes (log₂ Fold Change)", fontsize=14)
plt.tight_layout()
plt.show()
